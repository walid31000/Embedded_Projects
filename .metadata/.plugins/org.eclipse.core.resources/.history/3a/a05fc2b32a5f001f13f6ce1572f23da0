/*
 * main.c
 *description:Motor Dashboard
 *  Created on: 26 Apr 2024
 *      Author: walid
 */


#include "STD_TYPES.h"
#include "BIT_MATH.h"
#include "Err_Type.h"
#include <util/delay.h>

#include "DIO_interface.h"
#include "ADC_interface.h"
#include "PORT_interface.h"
#include "Timer_interface.h"

#include "DC_interface.h"
#include "Stepper_interface.h"
#include "KPD_interface.h"
#include "CLCD_interface.h"

/*Global variables*/
uint16 Local_u16ID;
uint16 Local_u16Pass;
uint8 Local_u8Counter=3;
uint8 Local_u8PassCounter=0;

/*function to get the ID from user*/
uint16 Get_ID()
{
	uint16 Local_u16_ID=0;
	uint8 Local_u8Key=0xff;
	uint8 Local_u8Counter=0;


	do
	{
		Local_u8Key=KPD_u8GetPressedKey();

		if((Local_u8Key>=0) && (Local_u8Key<=9))
		{
			CLCD_voidSendNumber(Local_u8Key);

			Local_u16_ID=Local_u16_ID*10+Local_u8Key;
			Local_u8Counter++;

		}
	}while(Local_u8Counter!=4 );

	return Local_u16_ID;
}

/*function to get the password from user*/
uint16 Get_Pass()
{
	uint16 Local_u16Pass=0;
	uint8 Local_u8Key=0xff;
	sint8 Local_u8Counter=0;
	uint8 Local_u8Xpos=8;

	do
	{
		Local_u8Key=KPD_u8GetPressedKey();

		if((Local_u8Key>=0) && (Local_u8Key<=9))
		{
			CLCD_voidSendNumber(Local_u8Key);
			_delay_ms(250);


			CLCD_voidClearGide(Local_u8Xpos,0,1);
			CLCD_voidSendData('*');
			Local_u8Xpos++;

			Local_u16Pass=Local_u16Pass*10+Local_u8Key;
			Local_u8Counter++;

		}
	}while(Local_u8Counter!=4 );

	return Local_u16Pass;
}
/*function to calculate the password*/

uint16 Calc_pass(uint16 copy_u16ID)
{
	uint16 Local_u16Pass=0;
	while(copy_u16ID)
	{
		uint16 Local_u16Digit=copy_u16ID%10;
		Local_u16Pass=Local_u16Pass*10+Local_u16Digit;
		copy_u16ID/=10;


	}

	return Local_u16Pass;


}
/*function to get the Angle from user*/
uint16 Calc_u16Angle()
{
	uint16 Local_u16Angle=0;
	uint8 Local_u8Key=0xff;



	do
	{
		Local_u8Key=KPD_u8GetPressedKey();

		if((Local_u8Key>=0) && (Local_u8Key<=9))
		{
			CLCD_voidSendNumber(Local_u8Key);
			Local_u16Angle=Local_u16Angle*10+Local_u8Key;


		}
	}while(Local_u8Key!='S' );

	return Local_u16Angle;
}

void main(void)
{
	uint8 Local_u8Key=0xff;
	uint16 Local_u16Angle=0;

	DC_config_t DC_Motor={DIO_PORTD,DIO_PIN6,DIO_PIN7 };
	Stepper_config_t Stepper={DIO_PORTD,DIO_PIN0,DIO_PIN1,DIO_PIN2,DIO_PIN3};

	PORT_voidIint();
	CLCD_voidInit ();
	Hamoksha();//show first animation on LCD using this function
	/*Login system*/
	CLCD_u8SendString("Enter ID:");
	Local_u16ID=Get_ID();//Get ID from user
	_delay_ms(500);

	CLCD_voidSendCommand(1);//clear screen
	CLCD_u8SendString("Password:");

	Local_u16Pass=Calc_pass(Local_u16ID);//calcualte password
	/*check password*/

	if( Local_u16Pass!=  Get_Pass())
	{
		do
		{
			CLCD_voidSendCommand(1);//clear screen
			CLCD_u8SendString("wrong password");
			_delay_ms(500);

			CLCD_voidSendCommand(1);//clear screen
			CLCD_u8SendString("Password:");
			Local_u16Pass=Get_Pass();//try another password

			Local_u8PassCounter++;
		}while(Local_u8PassCounter!=2);

		{
			CLCD_voidSendCommand(1);//clear screen

			CLCD_u8SendString("login failed");

		}


	}
	else
	{
		CLCD_voidSendCommand(1);//clear screen
		CLCD_u8SendString("Login sucessefuly");
		_delay_ms(1000);




	}
	/*show Motor menu on LCD*/
	/*	CLCD_u8SendStringAtPos(0u,0u,"DC MOTOR ---->1");
	CLCD_u8SendStringAtPos(0u,1u,"STEPER MOTOR->2");
	 */
	/*show motor menu on LCD*/
	CLCD_voidSendCommand(1);//clear screen
    CLCD_u8SendString("1-DCM,2-Stepper");
    CLCD_u8SendStringAtPos(0,1,"3-Servo motor");

	while(1)
	{

		Local_u8Key=KPD_u8GetPressedKey();

		if(Local_u8Key!=0xff )
		{

			CLCD_voidSendNumber(Local_u8Key);
			if (Local_u8Key==1)//DC MOTOR
			{

				CLCD_voidSendCommand(1);
				CLCD_u8SendStringAtPos(0u,0u,"Rot CW ->1");
				CLCD_u8SendStringAtPos(0u,1u,"Rot CCW->2");



				while(1)
				{
					Local_u8Key=KPD_u8GetPressedKey();
					if(Local_u8Key!=0xff )
					{
						if(Local_u8Key==1)//DC Clock Wise  direction
						{
							Motor_voidRotateCW( &DC_Motor);
							CLCD_voidSendCommand(1);
							CLCD_u8SendStringAtPos(0u,0u,"Press 0 to stop");


						}




						else if(Local_u8Key==2) //DC counter Clock Wise  direction
						{
							Motor_voidRotateCCW( &DC_Motor);
							CLCD_voidSendCommand(1);
							CLCD_u8SendStringAtPos(0u,0u,"Press 0 to stop");

						}
						else if((Local_u8Key==0))
						{
							CLCD_voidSendCommand(1);
							CLCD_u8SendStringAtPos(0u,1u,"Thanks");

							Motor_voidStop(&DC_Motor);
							Hamoksha_Reverse();//animation in reverse

						}


					}
				}
			}

			else if (Local_u8Key==2)//STEPPER MOTOR
			{


				/*show rotation menu*/
				CLCD_voidSendCommand(1);
				CLCD_u8SendStringAtPos(0u,0u,"Rot CW ->1");
				CLCD_u8SendStringAtPos(0u,1u,"Rot CCW->2");


				while(1)
				{

					Local_u8Key=KPD_u8GetPressedKey();
					if(Local_u8Key!=0xff )
					{
						if(Local_u8Key==1)//Stepper Clock Wise rotation
						{
							/*Read ANGLE*/
							CLCD_voidSendCommand(1);
							CLCD_u8SendStringAtPos(0u,0u,"Enter Angle");
							Local_u16Angle=Calc_u16Angle();

							Stepper_u8Stepper_Rotate( &Stepper, Local_u16Angle,Clock_Wise_ROT );
							CLCD_voidSendCommand(1);
							CLCD_u8SendStringAtPos(0u,1u,"Thanks");

							Hamoksha_Reverse();

						}




						else if(Local_u8Key==2)//Stepper counter Clock Wise rotation
						{
							/*Read ANGLE*/
							CLCD_voidSendCommand(1);
							CLCD_u8SendStringAtPos(0u,0u,"Enter Angle");
							Local_u16Angle=Calc_u16Angle();
							Stepper_u8Stepper_Rotate( &Stepper, Local_u16Angle,Counter_Clock_Wise_ROT );
							CLCD_voidSendCommand(1);
							CLCD_u8SendStringAtPos(0u,1u,"Thanks");

							Hamoksha_Reverse();


						}

					}

				}
			}
		}
	}


}




























